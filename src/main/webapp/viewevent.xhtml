<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
   xmlns:ui="http://java.sun.com/jsf/facelets"
   xmlns:f="http://java.sun.com/jsf/core"
   xmlns:h="http://java.sun.com/jsf/html"
   template="/WEB-INF/templates/simple.xhtml">
   <ui:define name="content">
      
    <script src="seam/remoting/resource/remote.js"/>
    <script src="seam/remoting/interface.js?eventDetail"/>
    
    <script type="text/javascript">
      // <![CDATA[
      
      var eventId = #{eventDetail.event.id};
      var dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      var monthNames = ["January", "February", "March", "April", "May", "June",
         "July", "August", "September", "October", "November", "December"];
         
      var selectedShowId = null;
      var sectionMap = null;      
      
      function venueSelected(ctl) {
        if (ctl.options[0].value == "") ctl.remove(0);
      
        var venueId = ctl.options[ctl.selectedIndex].value;
        if (venueId != null && "" != venueId) {
          var eventDetail = Seam.createBean("eventDetail");
          eventDetail.getShows(eventId, venueId, showCallback);
        }
      }
      
      function showCallback(shows) {
        var ctl = document.getElementById("eventDate");
        while (ctl.options.length > 0) ctl.remove(0);
        
        var option = document.createElement("option");
        option.text = "-- Please Select --";
        ctl.add(option, null);
        
        for (var i = 0; i < shows.length; i++) {
          var show = shows[i];
          var option = document.createElement("option");
          option.value = show.id;
          var prettyDate = dayNames[show.showDate.getDay()] + " " +
            show.showDate.getDate() + " " +
            monthNames[show.showDate.getMonth()] + " " +
            show.showDate.getFullYear() + " @ " +
            zeropad(show.showDate.getHours(), 2) + ":" +
            zeropad(show.showDate.getMinutes(), 2);
          option.text = prettyDate;
          ctl.add(option, null);
        }
      }
      
      function showSelected(ctl) {
        var showId = ctl.options[ctl.selectedIndex].value;
        if (showId != null && "" != showId) {
          selectedShowId = showId;
          var eventDetail = Seam.createBean("eventDetail");
          eventDetail.getEventPricing(showId, eventPricingCallback);        
        }
      }
      
      function eventPricingCallback(pricingMap) {
        sectionMap = pricingMap;
        
        var container = document.getElementById("pricing");
        while (container.hasChildNodes()) container.removeChild(container.firstChild);
        
        var sections = pricingMap.keySet();
        sections.sort(sectionCompare);
        for (var i = 0; i < sections.length; i++) {
          var section = sections[i];
          
          var sectionDiv = document.createElement("div");
          sectionDiv.className = "sectionContainer";
          
          var sectionNameDiv = document.createElement("div");
          sectionNameDiv.className = "sectionName";
          sectionNameDiv.appendChild(document.createTextNode(section.name));
          
          var sectionDescDiv = document.createElement("div");
          sectionDescDiv.className = "sectionDescription";
          sectionDescDiv.appendChild(document.createTextNode(section.description));
          
          sectionDiv.appendChild(sectionNameDiv);
          sectionDiv.appendChild(sectionDescDiv);
          
          var pricingDiv = document.createElement("div");
          pricingDiv.className = "pricing";         
          
          var cats = pricingMap.get(section);
          for (var j = 0; j < cats.length; j++) {
            var cat = cats[j];

            var pDiv = document.createElement("div");   
            
            var catSpan = document.createElement("span");
            catSpan.className = "ticketCat";
            catSpan.appendChild(document.createTextNode(cat.category.description + ": "));
            pDiv.appendChild(catSpan);         
            
            var priceSpan = document.createElement("span");
            priceSpan.className = "ticketPrice";
            priceSpan.appendChild(document.createTextNode(prettyPrice(cat.price)));
            
            pDiv.appendChild(priceSpan);            
            pricingDiv.appendChild(pDiv);
          }
          
          sectionDiv.appendChild(pricingDiv);
          container.appendChild(sectionDiv);        
        }
      }
      
      function prettyPrice(val) {
        val = "" + val;
        if (val.indexOf(".") == -1) {
          val += ".00";
        } else {
          while (val.substring(val.indexOf(".")).length < 3) val += "0";
        }
        return "$" + val;
      }
      
      function sectionCompare(a, b) {  
        for (var i = 0; i < a.name.length; i++) {
          if (b.name.length < (i + 1)) return 1;          
          if (a.name[i] == b.name[i]) continue;
          return (a.name[i] < b.name[i]) ? -1 : 1;          
        }        
        return 0;
      }
      
      function zeropad(val, digits) {
        val = val + "";
        while (val.length < digits) val = "0" + val;
        return val;
      }      
      
      function chooseShow() {
        clearPrices();
        document.getElementById("ticketSelection").style.display = "";
        document.getElementById("chooseShow").style.display = "";
        document.getElementById("chooseTickets").style.display = "none";
      }
      
      function chooseTickets() {
        document.getElementById("chooseShow").style.display = "none";
        document.getElementById("chooseTickets").style.display = "";
        
        var select = document.getElementById("sectionList");
        while (select.options.length > 0) select.remove(0);
        var opt = document.createElement("option");
        opt.text = "-- Please Select --";
        select.add(opt, null);
        
        var sections = sectionMap.keySet();       
        sections.sort(sectionCompare);
        for (var i = 0; i < sections.length; i++) {
          var section = sections[i];
          opt = document.createElement("option");
          opt.value = section.id;
          opt.text = section.name;
          select.add(opt, null);
        }
      }
      
      function sectionSelected(ctl) {
        var sectionId = ctl.options[ctl.selectedIndex].value;
        if (sectionId != null && "" != sectionId) {
          var sections = sectionMap.keySet();
          var section = null;
          for (var i = 0; i < sections.length; i++) {
            if (sections[i].id == sectionId) {
              section = sections[i];
              break;
            }
          }
        
          if (section != null) {        
            clearPrices();
            document.getElementById("ticketSelection").style.display = "";
            var prices = sectionMap.get(section);
            for (var i = 0; i < prices.length; i++) {
              addPricingRow(prices[i], 10);
            }
          }
        }
      }
      
      function clearPrices() {
        var tbl = document.getElementById("ticketSelection");
        while (tbl.rows.length > 1) tbl.deleteRow(tbl.rows.length - 1);        
      }
      
      function addPricingRow(cat, qtyAvailable) {
        var tbl = document.getElementById("ticketSelection");
        
        var rowClass = tbl.rows.length % 2 == 0 ? "even" : "odd";
        var row = tbl.insertRow(-1);
        row.className = rowClass;
        
        var td = document.createElement("td");
        td.appendChild(document.createTextNode(cat.category.description));
        row.appendChild(td);
        
        td = document.createElement("td");
        td.appendChild(document.createTextNode(prettyPrice(cat.price)));
        row.appendChild(td);
        
        td = document.createElement("td");
        
        var select = document.createElement("select");
        
        if (qtyAvailable == 0) {
          var opt = document.createElement("option");
          opt.text = "Sold out";
          select.add(opt, null);
        } else {
          for (var i = 0; i <= qtyAvailable; i++) {
            var opt = document.createElement("option");
            opt.value = i;
            opt.text = i;
            select.add(opt, null);
          }
        }
                
        td.appendChild(select);
        row.appendChild(td);        
      }
      
      // ]]>
    
    </script>
   
    <div class="section">
      <div class="sectionHeader">
        Event
      </div>
      
      <div class="sectionContent">
        <h:outputText value="#{eventDetail.event.description.activeRevision.content}" escape="false"/>
        <br style="clear:both"/>        
      </div>      
    </div>
    
    <br style="clear:both"/>
    
    <div id="chooseShow" class="section">
      <div class="sectionHeader">
        Buy Tickets
      </div>
      
      <div class="sectionContent">
        <div>
          <span>Select a venue: </span>
          <h:selectOneMenu onchange="venueSelected(this)">
            <f:selectItem itemLabel="-- Please Select --"/>
            <f:selectItems value="#{eventDetail.venues}"
               var="venue" itemValue="#{venue.id}" itemLabel="#{venue.name}"/>             
          </h:selectOneMenu>
  
          <span style="margin-left:12px">Select a date: </span>
          <select id="eventDate" size="1" onchange="showSelected(this)"/>
        </div>
        
        <div id="pricing" style="margin-top: 1px solid #000000">
          
        </div>
        
        <br style="clear:both"/>        
      </div>
      
      <div class="buttonRow">
        <div class="buttonRight">
          <a href="#" onclick="javascript:chooseTickets()"><img src="style/buytickets.png"/></a>
        </div>
        <br style="clear:both"/>
      </div>
      
    </div>
    
    <div id="chooseTickets" style="display:none" class="section">
      <div class="sectionHeader">
        Choose Tickets
      </div>
      
      <div class="sectionContent">
        <div>
          <span>Select a section: </span>
          <select id="sectionList" onchange="sectionSelected(this)"/>

          <div id="availability">
            <b>Availability:</b><br/>
            <div id="ticketAvailability">
            
            </div>
          </div>
          
          <div style="margin-top: 8px">
            <table id="ticketSelection" style="display:none" cellspacing="0" cellpadding="5">
              <tr class="header">
                <th width="50%">Ticket</th>
                <th>Price</th>
                <th>Quantity</th>
              </tr>
            
            </table>
          </div>

        </div>
        
        <div class="buttonRow">
          <div class="buttonLeft">
            <a href="#" onclick="javascript:chooseShow()"><img src="style/btn_previous.png"/></a>
          </div>
          <div class="buttonRight">
            <a href="#" onclick="javascript:reserveTickets()"><img src="style/btn_next.png"/></a>
          </div>
          <br style="clear:both"/>
        </div>
        
      </div>        

    </div>
    
    <br style="clear:both"/>    
    
   </ui:define>
</ui:composition>
